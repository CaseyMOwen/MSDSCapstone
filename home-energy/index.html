<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
        <title>Home Energy</title>
        <link href="styles/styles.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css">
    </head>

    <body>
        <div id="content">   
        <h1>Home Energy Calculator</h1>
        <div id="yearRangeButtons">
            <!-- Dropdown pairs will be appended here -->
        </div>
        <div id="countySelectContainer">
            <!-- Dropdown pairs will be appended here -->
        </div>
        <div id="dropdownContainer">
            <!-- Dropdown pairs will be appended here -->
        </div>
        
        <button id="addDropdownButton">Add Feature</button>
    <!-- </br>
    </br> -->
        <div id="featuredescription"></div>
        
        <script>
            const dropdownContainer = document.getElementById('dropdownContainer');
            const addDropdownButton = document.getElementById('addDropdownButton');
            featuresDict = {}
            
            function createRadioButtons(containerId, options) {
                const container = document.getElementById(containerId);

                options.forEach((option) => {
                    const radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'year_ranges'; // Set a common name for the radio buttons
                    radio.value = option.value; // Set the value for each radio button
                    radio.id = `radio_${option.value}`; // Unique ID for each radio button
                    radio.checked = option.checked

                    const label = document.createElement('label');
                    label.htmlFor = radio.id;
                    label.textContent = option.label;

                    container.appendChild(radio);
                    container.appendChild(label);
                });
            }

            // Example usage:
            const radioOptions = [
                { value: '1980-1999', label: '1980-1999', checked: false},
                { value: '2000-2019', label: '2000-2019', checked: false},
                { value: '2020-2039', label: '2020-2039', checked: true},
                { value: '2040-2059', label: '2040-2059', checked: false},
                { value: '2060-2079', label: '2060-2079', checked: false},
                { value: '2080-2099', label: '2080-2099', checked: false}
            ];

            createRadioButtons('yearRangeButtons', radioOptions);


            function createCountySelector() {
                fetch('county_lookup.json')
                .then((response) => response.json())
                .then((county_json) => {

                // Populate the state dropdown
                const stateSelect = document.createElement('select');
                stateSelect.setAttribute("id", "state-select")
                stateSelect.setAttribute("required", "required")
                const countySelect = document.createElement('select');
                countySelect.setAttribute("required", "required")
                countySelect.setAttribute("id", "county-select")
                countySelectContainer.appendChild(stateSelect)
                countySelectContainer.appendChild(countySelect)

                for (const state in county_json) {
                    if (state == "AK" || state == "HI" || state == "PR"){
                        continue
                    }
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    stateSelect.appendChild(option);
                }
                
                function populateCounties() {
                    // Clear previous county options
                    countySelect.innerHTML = '<option value="">Select a county</option>';

                    // Get selected state
                    const selectedState = stateSelect.value;

                    // Enable county dropdown if a valid state is selected
                    if (selectedState) {
                        countySelect.disabled = false;

                        // Populate county dropdown
                        const counties = county_json[selectedState];
                        for (const county of counties) {
                            const option = document.createElement('option');
                            option.value = county['gisjoin'];
                            option.textContent = county['name'];
                            countySelect.appendChild(option);
                        }
                    } else {
                        countySelect.disabled = true;
                    }
                    }
                // Event listener for state dropdown
                stateSelect.selectedIndex=0
                populateCounties()
                stateSelect.addEventListener('change', populateCounties);

                })
            }

            function createDropdownPair() {
                fetch('data_dictionary.json')
                .then((response) => response.json())
                .then((feat_json) => {
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = 'dropdown-pair';
                    dropdownContainer.appendChild(wrapper)

                    const featureSelect = document.createElement('select');
                    featurevalueSelect = document.createElement('select');
                    featurevalueInput = null
                    const description = document.createElement('div')
                    featureSelect.className = 'feature-select'
                    featurevalueSelect.className = 'feature-value'
                    description.className = 'feature-description'
                    wrapper.appendChild(featureSelect)
                    wrapper.appendChild(featurevalueSelect)
                    wrapper.appendChild(description)

                    featurevalueSelect.disabled = true;

                    // Populate the country dropdown
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select a feature';
                    featureSelect.appendChild(defaultOption);

                    for (const feature in feat_json) {
                        if (feature.startsWith("in.")) {
                            const option = document.createElement('option');
                            option.value = feature;
                            option.textContent = feature;
                            featureSelect.appendChild(option);
                        }
                    }

                    const defaultFeatureValueOption = document.createElement('option');
                    defaultFeatureValueOption.value = '';
                    defaultFeatureValueOption.textContent = 'Select a value';
                    featurevalueSelect.appendChild(defaultFeatureValueOption);

                    // Event listener for country dropdown
                    featureSelect.addEventListener('change', function() {
                        const selectedFeature = featureSelect.value;
                        
                        if (feat_json[selectedFeature]['type'] == 'category') {
                            if (featurevalueInput != null) {
                                featurevalueSelect = document.createElement('select');
                                featurevalueInput.replaceWith(featurevalueSelect)
                            }
                            featurevalueSelect.innerHTML = '<option value="">Select a value</option>';
                            if (selectedFeature) {
                                featurevalueSelect.disabled = false;
                                const featurevalues = feat_json[selectedFeature]['enumerations'];
                                // description.innerHTML = feat_json[selectedFeature]['field_description']
                                for (const featurevalue of featurevalues) {
                                    const option = document.createElement('option');
                                    option.value = featurevalue;
                                    option.textContent = featurevalue;
                                    featurevalueSelect.appendChild(option);
                                }
                            // createDropdownPair();
                            } else {
                                featurevalueSelect.disabled = true;
                            }
                        } else {
                            featurevalueInput = document.createElement('input');
                            featurevalueInput.className = 'feature-value'
                            featurevalueSelect.replaceWith(featurevalueInput)
                            description.innerHTML = feat_json[selectedFeature]['field_description']
                            // featurevalueSelect.innerHTML = '<input></input>';
                        }
                    });
                })
            }

            // function addDropdownPair() {
            //     createDropdownPair();
            // }

            createCountySelector();
            // Initial dropdown pair
            createDropdownPair();

            // Add new dropdown pair when button is clicked
            addDropdownButton.addEventListener('click', createDropdownPair);

            function getFeatureDict() {
                county = document.getElementById('county-select').value
                state = document.getElementById('state-select').value
                year_container = document.getElementById('yearRangeButtons')
                inputs = year_container.getElementsByTagName('input')
                for (var i = 0; i < inputs.length; ++i)
                    if (inputs[i].checked) {
                        year_range = inputs[i].value
                    }
                if(county==="" || state ===""){
                    alert("You must select both a state and a county");
                    return false;
                }
                featDict = {"in.county": county, "in.state": state, "year_range": year_range}
                for (let i = 0; i < dropdownContainer.children.length; i++) {
                    const pair = dropdownContainer.children[i];
                    const feature = pair.getElementsByClassName('feature-select')[0].value
                    const featureValue = pair.getElementsByClassName('feature-value')[0].value
                    if (featureValue != "") {
                        featDict[feature] = featureValue
                    }
                }
                console.log(featDict);
                return featDict
            }
    
        </script>        
        
        
    </br></br>
    <button id="postButton">Get Savings</button>
        <script src="api.js"></script>
    </br>
        <div id="25th Percentile"></div>
        <div id="Median"></div>
        <div id="75th Percentile"></div>

    </div>

    </body>


    